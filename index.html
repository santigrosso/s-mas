<script>
/* ===== Descripciones ===== */
const DESCRIPTIONS={
  toeoff:"Punto inmediatamente anterior a que el pie contralateral deje el suelo.",
  mvp:"Punto intermedio entre el toe-off y el touch-down; la pelvis se encuentra en su punto más alto de la fase de swing.",
  lateswing:"Punto de máxima extensión de rodilla durante la fase de swing.",
  touchdown:"Punto de primer contacto con el suelo.",
  midstance:"Punto donde la pelvis está posicionada directamente sobre la articulación del tobillo."
};

/* ===== Momentos/Preguntas ===== */
const MOMENTS=[
  {key:'toeoff',label:'Toe-off'},
  {key:'mvp',label:'Max Vertical Projection'},
  {key:'lateswing',label:'Late Swing'},
  {key:'touchdown',label:'Touchdown'},
  {key:'midstance',label:'Mid-stance'},
];
const QUESTIONS={
  toeoff:["¿Demasiada extensión de cadera?"],                               // #1
  mvp:["¿Rotación excesiva de tronco?","¿Está el talón de la pierna trasera por encima de la pantorrilla?"], // #2 #3
  lateswing:["¿Anteversión pélvica o extensión lumbar entre MVP y Late swing?","¿Está la rodilla por detrás de los glúteos?"], // #4 #5
  touchdown:["¿Está el tronco inclinado hacia delante?","¿Hay anteversión pélvica o extensión lumbar?","¿Hay más de 20° entre ambos muslos?","¿Está el pie muy adelantado en relación al CdG?","¿La tibia está inclinada?","¿El primer apoyo es muy marcado con talón o punta?"], // #6..#11
  midstance:["¿Está la rodilla por delante de la punta del pie?"]            // #12
};

/* ===== Estado ===== */
const GRADE=(s)=> s<=1?"Excelente (0–1)": s===2?"Bueno (2)": s<=5?"Promedio (3–5)": s===6?"Pobre (6)": s<=11?"Muy pobre (7–11)":"Extremadamente pobre (12)";
let state={
  fps:240,invert:false,curMoment:'toeoff',
  moments:Object.fromEntries(MOMENTS.map(m=>[m.key,{
    t:0,frame:0,notes:'',checks:QUESTIONS[m.key].map(()=>false), snapshots:[], captured:false, guides: {}
  }]))
};

/* ===== DOM ===== */
const $=s=>document.querySelector(s);
const file=$('#file'),vid=$('#vid'),wrap=$('#videoWrap');
const cvs=$('#overlay'),ctx=cvs.getContext('2d');
const mag=$('#magnifier'), mctx=mag.getContext('2d');
const fpsInput=$('#fps'),ctime=$('#ctime'),fnum=$('#fnum');
const tabs=$('#tabs'),momentDesc=$('#momentDesc'),questions=$('#questions'),curMomentLabel=$('#curMomentLabel');
const notesEl=$('#notes'), guidesPanel=$('#guidesPanel');
const printBtn=$('#printReport'),reportHint=$('#reportHint');
const invertBtn=$('#invert');
const momentScoreEl=document.getElementById('momentScore'), totalScoreEl=document.getElementById('totalScore'), gradeEl=document.getElementById('grade');
const scrub=$('#scrubber'), playBar=$('#playBar'), bufBar=$('#bufBar'), thumb=$('#thumb'), curT=$('#curT'), durT=$('#durT');

/* ===== Tooltips ===== */
let tipEl=null, tipAnchor=null;
function toggleTip(anchor, text){ if(tipEl && tipAnchor===anchor){ closeTip(); return; } showTip(anchor, text); }
function showTip(anchorEl, text){
  closeTip(); tipEl=document.createElement('div'); tipEl.className='helpTip'; tipEl.textContent=text;
  document.body.appendChild(tipEl); tipAnchor=anchorEl; positionTip();
  setTimeout(()=>{
    document.addEventListener('mousedown', onDocDown, true);
    document.addEventListener('touchstart', onDocDown, {passive:false, capture:true});
    window.addEventListener('keydown', onKey);
    window.addEventListener('scroll', closeTip, {passive:true});
    window.addEventListener('resize', onResize, {passive:true});
  },0);
}
function positionTip(){ if(!tipEl || !tipAnchor) return;
  const r=tipAnchor.getBoundingClientRect(); const tt=tipEl.getBoundingClientRect();
  let left = r.left - tt.width - 8; let top  = r.top + window.scrollY - (tt.height/2) + (r.height/2);
  if(left < 6){ left = r.right + 8; } const maxTop = window.scrollY + window.innerHeight - tt.height - 6; const minTop = window.scrollY + 6;
  top = Math.max(minTop, Math.min(maxTop, top)); tipEl.style.left = left + 'px'; tipEl.style.top  = top + 'px';
}
function onDocDown(e){ if(!tipEl) return; if(tipEl.contains(e.target) || e.target===tipAnchor){ return; } closeTip(); }
function onKey(e){ if(e.key==='Escape') closeTip(); }
function onResize(){ positionTip(); }
function closeTip(){ if(!tipEl) return; tipEl.remove(); tipEl=null; tipAnchor=null;
  document.removeEventListener('mousedown', onDocDown, true);
  document.removeEventListener('touchstart', onDocDown, {capture:true});
  window.removeEventListener('keydown', onKey);
  window.removeEventListener('scroll', closeTip);
  window.removeEventListener('resize', onResize);
}

/* ===== Helpers ===== */
function ensureGuideState(momentKey, guideKey){
  const m=state.moments[momentKey];
  if(!m.guides[guideKey]){ m.guides[guideKey]={on:false, data:{}}; }
  return m.guides[guideKey];
}
function allCaptured(){ return MOMENTS.every(m=>state.moments[m.key].captured); }
function updateReportAvailability(){ const ok=allCaptured(); printBtn.disabled=!ok; reportHint.style.display=ok?'none':'inline'; }
function setMoment(key){
  state.curMoment=key;
  renderTabs(); renderGuidesPanel();
  momentDesc.textContent=DESCRIPTIONS[key];
  curMomentLabel.textContent=MOMENTS.find(m=>m.key===key).label;
  renderQuestions(); notesEl.value=state.moments[key].notes||''; refreshScores(); draw();
}
function renderTabs(){
  tabs.innerHTML='';
  MOMENTS.forEach(m=>{
    const b=document.createElement('button');
    b.className='tab'+(state.curMoment===m.key?' active':'');
    if(state.moments[m.key].captured) b.classList.add('captured');
    b.dataset.key=m.key; b.onclick=()=>setMoment(m.key);
    b.innerHTML=`<span class="text">${m.label}</span><span class="tick">✓</span>`;
    tabs.appendChild(b);
  });
  updateReportAvailability();
}
function renderGuidesPanel(){
  guidesPanel.innerHTML='';
  const GUIDE_DEFS={
    toeoff:[ {key:'g45', label:'Guía 45° extensión', use:'Ubica el punto en el centro de la cadera y comprueba si la extensión de cadera supera los 45°.'} ],
    mvp:[ {key:'heel', label:'Guía talón', use:'Ubica el punto en el talón y comprueba si la pantorrilla está por encima.'} ],
    lateswing:[ {key:'vh', label:'Guía rodilla', use:'Ubica el cruce en la zona glútea y comprueba si la rodilla queda por detrás y si se observa anteversión pélvica.'} ],
    touchdown:[
      {key:'t15', label:'Guía 15° tronco', use:'Ubica el punto en el trocánter y comprueba si el tronco excede los 15° de flexión respecto de la vertical.'},
      {key:'thighs', label:'Ángulo muslos', use:'Tocá primero el vértice del ángulo y luego los otros dos puntos. Comprobá que no sea superior a 20°.'},
      {key:'cdg', label:'Guía distancia CdG', use:'Ubica el punto en el talón y compara la medida del pie con la distancia a la vertical.'},
      {key:'tibia', label:'Guía tibia', use:'Ubicá el punto en el centro de la articulación del tobillo y comprobá que la rodilla no esté por detrás.'}
    ],
    midstance:[ {key:'knee', label:'Guía rodilla', use:'Ubicá la línea vertical (puntos en extremos) con el punto superior en la rodilla y verificá que no esté por delante de la punta del pie.'} ]
  }[state.curMoment]||[];
  GUIDE_DEFS.forEach(def=>{
    const row=document.createElement('div'); row.className='q';
    const lab=document.createElement('label'); lab.textContent=def.label;
    const help=document.createElement('span'); help.className='help'; help.textContent='?';
    help.addEventListener('click', (e)=>toggleTip(e.currentTarget, def.use));
    help.addEventListener('touchstart', (e)=>{ e.preventDefault(); toggleTip(e.currentTarget, def.use); }, {passive:false});
    const sw=document.createElement('label'); sw.className='switch';
    const g = ensureGuideState(state.curMoment, def.key);
    const input=document.createElement('input'); input.type='checkbox'; input.checked=!!g.on;
    input.onchange=()=>{ g.on=input.checked; draw(); };
    const slid=document.createElement('span'); slid.className='slider';
    sw.appendChild(input); sw.appendChild(slid);
    lab.appendChild(help);
    row.appendChild(lab); row.appendChild(sw);
    guidesPanel.appendChild(row);
  });
}
function renderQuestions(){
  const m=state.moments[state.curMoment];
  questions.innerHTML='';
  (QUESTIONS[state.curMoment]||[]).forEach((q,i)=>{
    const row=document.createElement('div'); row.className='q';
    const lab=document.createElement('label'); lab.textContent=q;
    const sw=document.createElement('label'); sw.className='switch';
    const input=document.createElement('input'); input.type='checkbox'; input.checked=!!m.checks[i];
    input.onchange=()=>{ m.checks[i]=input.checked; refreshScores(); draw(); };
    const slid=document.createElement('span'); slid.className='slider';
    sw.appendChild(input); sw.appendChild(slid);
    row.appendChild(lab); row.appendChild(sw);
    questions.appendChild(row);
  });
}
function refreshScores(){
  const cur = state.moments[state.curMoment].checks.filter(Boolean).length;
  const total = Object.values(state.moments).reduce((acc,mm)=> acc + mm.checks.filter(Boolean).length, 0);
  momentScoreEl.textContent = cur; totalScoreEl.textContent = total; gradeEl.textContent = GRADE(total);
}

/* ===== Video / Dibujo ===== */
function sizeCanvasToWrap(){ const r=wrap.getBoundingClientRect(); cvs.width=r.width; cvs.height=r.height; mag.width=r.width; mag.height=r.height; }
function draw(){ if(!vid.videoWidth) return; sizeCanvasToWrap(); ctx.clearRect(0,0,cvs.width,cvs.height); ctx.drawImage(vid,0,0,cvs.width,cvs.height); drawGuides(); drawMagnifier(); }
function stepFrames(n){ const fps=Number(state.fps)||240; vid.pause(); const dt=n/fps; const t=Math.max(0,Math.min(vid.duration||0,(vid.currentTime||0)+dt)); vid.currentTime=t; }
function updateTimeUI(){
  const t=vid.currentTime||0, d=vid.duration||0;
  ctime.textContent=t.toFixed(3);
  const fps=Number(state.fps)||240; fnum.textContent=Math.round(t*fps);
  const m=state.moments[state.curMoment]; m.t=t; m.frame=Math.round(t*fps);
  if(d>0){
    const pct=(t/d)*100; playBar.style.width=pct+'%'; thumb.style.left=pct+'%';
    durT.textContent=formatTime(d); curT.textContent=formatTime(t);
    try{ let end=0; if(vid.buffered && vid.buffered.length){ end=vid.buffered.end(vid.buffered.length-1); } bufBar.style.width=(Math.min(end,d)/d)*100+'%'; }catch(e){}
  }
}
function formatTime(s){ s=Math.max(0,Math.floor(s||0)); const m=Math.floor(s/60); const ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }
vid.addEventListener('timeupdate',()=>{ updateTimeUI(); draw(); });
vid.addEventListener('seeked',()=>{ updateTimeUI(); draw(); });
vid.addEventListener('loadedmetadata',()=>{ updateTimeUI(); });
vid.addEventListener('progress',()=>{ updateTimeUI(); });
window.addEventListener('resize', draw);

/* ===== Scrubber ===== */
let scrubbing=false;
function posToTime(clientX){ const r=scrub.getBoundingClientRect(); const x=Math.max(0,Math.min(clientX - r.left, r.width)); const pct=x/r.width; return (vid.duration||0)*pct; }
function beginScrub(clientX){ scrubbing=true; vid.pause(); vid.currentTime=posToTime(clientX); updateTimeUI(); draw(); }
function moveScrub(clientX){ if(!scrubbing) return; vid.currentTime=posToTime(clientX); updateTimeUI(); draw(); }
function endScrub(){ if(!scrubbing) return; scrubbing=false; }
scrub.addEventListener('mousedown',(e)=>{ beginScrub(e.clientX); e.preventDefault(); });
window.addEventListener('mousemove',(e)=>{ moveScrub(e.clientX); });
window.addEventListener('mouseup',()=>{ endScrub(); });
scrub.addEventListener('touchstart',(e)=>{ if(e.touches.length){ beginScrub(e.touches[0].clientX); } e.preventDefault(); }, {passive:false});
window.addEventListener('touchmove',(e)=>{ if(scrubbing && e.touches.length){ moveScrub(e.touches[0].clientX); } }, {passive:false});
window.addEventListener('touchend',()=>{ endScrub(); });

/* ===== Overlay + Lupa ===== */
let dragging=null, dragKey=null; let placingActive=false;
const MAG_RADIUS=70, MAG_SCALE=2.5, MAG_OFFSET={x:90,y:-90};
let magVisible=false, magSrc={x:0,y:0}, magPos={x:0,y:0};
function toCanvasCoords(ev){ const r=cvs.getBoundingClientRect(); const x=(ev.touches?ev.touches[0].clientX:ev.clientX)-r.left; const y=(ev.touches?ev.touches[0].clientY:ev.clientY)-r.top; return {x,y}; }
function hit(pt,x,y){ return pt && Math.hypot(pt.x-x,pt.y-y)<16; }
function cm(){ return state.moments[state.curMoment]; }
function activeGuides(){ const g=cm().guides; return Object.entries(g).filter(([k,v])=>v.on); }
function showMag(cx,cy,px,py){ magVisible=true; mag.style.display='block'; magSrc.x=cx; magSrc.y=cy; magPos.x=Math.max(MAG_RADIUS, Math.min(cvs.width-MAG_RADIUS, px+MAG_OFFSET.x)); magPos.y=Math.max(MAG_RADIUS, Math.min(cvs.height-MAG_RADIUS, py+MAG_OFFSET.y)); drawMagnifier(); }
function moveMag(cx,cy,px,py){ if(!magVisible) return; magSrc.x=cx; magSrc.y=cy; magPos.x=Math.max(MAG_RADIUS, Math.min(cvs.width-MAG_RADIUS, px+MAG_OFFSET.x)); magPos.y=Math.max(MAG_RADIUS, Math.min(cvs.height-MAG_RADIUS, py+MAG_OFFSET.y)); drawMagnifier(); }
function hideMag(){ magVisible=false; mag.style.display='none'; }
function drawMagnifier(){
  const mw=cvs.width, mh=cvs.height; mag.width=mw; mag.height=mh; mctx.clearRect(0,0,mw,mh); if(!magVisible) return;
  const sx = magSrc.x - (MAG_RADIUS/MAG_SCALE), sy = magSrc.y - (MAG_RADIUS/MAG_SCALE);
  const sw = (MAG_RADIUS*2)/MAG_SCALE, sh = (MAG_RADIUS*2)/MAG_SCALE;
  mctx.save(); mctx.beginPath(); mctx.arc(magPos.x, magPos.y, MAG_RADIUS, 0, Math.PI*2); mctx.closePath(); mctx.clip();
  mctx.fillStyle='rgba(0,0,0,1)'; mctx.fillRect(magPos.x-MAG_RADIUS, magPos.y-MAG_RADIUS, MAG_RADIUS*2, MAG_RADIUS*2);
  mctx.imageSmoothingEnabled=true; mctx.drawImage(cvs, sx, sy, sw, sh, magPos.x-MAG_RADIUS, magPos.y-MAG_RADIUS, MAG_RADIUS*2, MAG_RADIUS*2);
  mctx.strokeStyle='rgba(255,255,255,.9)'; mctx.lineWidth=1.5; mctx.beginPath();
  mctx.moveTo(magPos.x-MAG_RADIUS, magPos.y); mctx.lineTo(magPos.x+MAG_RADIUS, magPos.y);
  mctx.moveTo(magPos.x, magPos.y-MAG_RADIUS); mctx.lineTo(magPos.x, magPos.y+MAG_RADIUS); mctx.stroke();
  mctx.strokeStyle='rgba(255,255,255,.8)'; mctx.lineWidth=2; mctx.beginPath(); mctx.arc(magPos.x, magPos.y, MAG_RADIUS, 0, Math.PI*2); mctx.stroke(); mctx.restore();
}
function startDrag(ev){
  placingActive=true; const {x,y}=toCanvasCoords(ev); showMag(x,y,x,y);
  const list = activeGuides();
  for(const [key, g] of list){
    const d=g.data;
    if(key==='thighs'){
      if(hit(d.v,x,y)){ dragging='v'; dragKey=key; return ev.preventDefault(); }
      if(hit(d.a,x,y)){ dragging='a'; dragKey=key; return ev.preventDefault(); }
      if(hit(d.b,x,y)){ dragging='b'; dragKey=key; return ev.preventDefault(); }
    } else if(key==='cdg'){
      if(hit(d.a,x,y)){ dragging='a'; dragKey=key; return ev.preventDefault(); }
      if(hit(d.b,x,y)){ dragging='b'; dragKey=key; return ev.preventDefault(); }
    } else if(key==='heel'){
      if(hit(d.p,x,y)){ dragging='p'; dragKey=key; return ev.preventDefault(); }
    } else if(['vh','t15','g45','knee','tibia'].includes(key)){
      if(hit(d.anchor,x,y)){ dragging='anchor'; dragKey=key; return ev.preventDefault(); }
    }
  }
  for(const [key,g] of list){
    const d=g.data;
    if(key==='thighs'){
      if(!d.v){ d.v={x,y}; dragging='v'; dragKey=key; break; }
      else if(!d.a){ d.a={x,y}; dragging='a'; dragKey=key; break; }
      else if(!d.b){ d.b={x,y}; dragging='b'; dragKey=key; break; }
    } else if(key==='cdg'){
      if(!d.a){ d.a={x,y}; dragging='a'; dragKey=key; break; }
      else if(!d.b){ d.b={x,y}; dragging='b'; dragKey=key; break; }
    } else if(key==='heel'){
      if(!d.p){ d.p={x,y}; dragging='p'; dragKey=key; break; }
    } else if(['vh','t15','g45','knee','tibia'].includes(key)){
      if(!d.anchor){ d.anchor={x,y}; dragging='anchor'; dragKey=key; break; }
    }
  }
  draw(); ev.preventDefault();
}
function moveDrag(ev){
  if(!placingActive) return; const {x,y}=toCanvasCoords(ev); moveMag(x,y,x,y);
  if(!dragging) return; const g=cm().guides[dragKey]; if(!g) return; const d=g.data;
  if(dragging==='v') d.v={x,y}; if(dragging==='a') d.a={x,y}; if(dragging==='b') d.b={x,y}; if(dragging==='p') d.p={x,y}; if(dragging==='anchor') d.anchor={x,y};
  draw(); ev.preventDefault();
}
function endDrag(){ placingActive=false; dragging=null; dragKey=null; hideMag(); draw(); }
cvs.addEventListener('mousedown', startDrag);
cvs.addEventListener('mousemove', moveDrag);
cvs.addEventListener('mouseup', endDrag);
cvs.addEventListener('mouseleave', endDrag);
cvs.addEventListener('touchstart', startDrag,{passive:false});
cvs.addEventListener('touchmove', moveDrag,{passive:false});
cvs.addEventListener('touchend', endDrag);

/* ===== Dibujo de guías ===== */
function line(x1,y1,x2,y2,dash=[],color='white',width=2){ ctx.save(); ctx.setLineDash(dash); ctx.lineWidth=width; ctx.strokeStyle=color; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); ctx.restore(); }
function dot(x,y){ ctx.save(); const rr=(placingActive?10:4); ctx.fillStyle='rgba(255,255,255,0.75)'; ctx.beginPath(); ctx.arc(x,y,rr,0,Math.PI*2); ctx.fill(); ctx.restore(); }
function drawVerticalPlusAngleFromVertical(x,y,deg,invert=false){
  line(x,0,x,cvs.height,[], 'rgba(255,255,255,.85)');
  const base=90-deg, theta=(invert?-1:1)*(base*Math.PI/180), len=Math.max(cvs.width,cvs.height);
  const dx=Math.cos(theta)*len, dy=-Math.sin(theta)*len;
  line(x-dx, y+dy, x+dx, y-dy, [6,4], 'rgba(255,255,255,.85)'); dot(x,y);
}
function drawVHAt(x,y){ line(x,0,x,cvs.height,[], 'rgba(255,255,255,.85)'); line(0,y,cvs.width,y,[], 'rgba(255,255,255,.85)'); dot(x,y); }
function angleBetween(p0,p1,p2){
  const v1={x:p0.x-p1.x,y:p0.y-p1.y}, v2={x:p2.x-p1.x,y:p2.y-p1.y};
  const d1=Math.hypot(v1.x,v1.y)||1, d2=Math.hypot(v2.x,v2.y)||1;
  const cos=(v1.x*v2.x+v1.y*v2.y)/(d1*d2);
  return Math.acos(Math.min(1,Math.max(-1,cos)))*180/Math.PI;
}
function drawGuides(){
  const list = activeGuides();
  for(const [key,g] of list){
    const d=g.data;
    if(key==='g45' && d.anchor){ drawVerticalPlusAngleFromVertical(d.anchor.x, d.anchor.y, 45, state.invert); }
    if(key==='heel' && d.p){ line(0,d.p.y,cvs.width,d.p.y,[], 'rgba(255,255,255,.85)',2); dot(d.p.x,d.p.y); }
    if(key==='vh' && d.anchor){ drawVHAt(d.anchor.x, d.anchor.y); }
    if(key==='t15' && d.anchor){ drawVerticalPlusAngleFromVertical(d.anchor.x, d.anchor.y, 15, state.invert); }
    if(key==='thighs'){
      const {v,a,b}=d;
      if(v) dot(v.x,v.y); if(a) dot(a.x,a.y); if(b) dot(b.x,b.y);
      if(v && a){ line(v.x,v.y,a.x,a.y,[], '#fff',2); }
      if(v && b){ line(v.x,v.y,b.x,b.y,[], '#fff',2); }
      if(v && a && b){
        const ang=angleBetween(a,v,b);
        ctx.save(); ctx.fillStyle = ang>20 ? 'rgba(231,76,60,.9)' : 'rgba(25,179,106,.9)';
        ctx.font='bold 14px system-ui'; ctx.fillText(`${ang.toFixed(1)}°`, v.x+8, v.y-8); ctx.restore();
        if(ang>20){ ctx.save(); ctx.strokeStyle='rgba(231,76,60,1)'; ctx.lineWidth=4; ctx.beginPath(); ctx.arc(v.x,v.y,24,0,Math.PI*2); ctx.stroke(); ctx.restore(); }
      }
    }
    if(key==='cdg'){
      const {a,b}=d; if(a) dot(a.x,a.y); if(b) dot(b.x,b.y);
      if(a && b){
        const y = a.y, x1 = a.x, x2 = b.x;
        line(x1, y, x2, y, [6,4], 'rgba(255,255,255,.85)',2);
        const dx = Math.abs(Math.round(x2 - x1));
        ctx.save(); ctx.fillStyle='rgba(255,255,255,.9)'; ctx.font='bold 13px system-ui';
        ctx.fillText(`Δx: ${dx}px`, Math.min(x1,x2)+5, y-8); ctx.restore();
      }
    }
    if(key==='knee' && d.anchor){
      const h = cvs.height*0.12; const x=d.anchor.x, y1=d.anchor.y-h/2, y2=d.anchor.y+h/2;
      line(x,y1,x,y2,[], 'rgba(255,255,255,.95)',3); dot(x,y1); dot(x,y2);
    }
    if(key==='tibia' && d.anchor){
      const h = cvs.height*0.12; const x=d.anchor.x, y1=d.anchor.y-h/2, y2=d.anchor.y+h/2;
      line(x,y1,x,y2,[], 'rgba(255,255,255,.95)',3); dot(x,y1); dot(x,y2);
    }
  }
  ctx.save(); ctx.fillStyle='rgba(255,255,255,.6)'; ctx.font='12px system-ui'; ctx.fillText('Activá guías y tocá para ubicarlas. Arrastrá para ajustar.',10,cvs.height-10); ctx.restore();
}

/* ===== Controles ===== */
document.getElementById('play').onclick=async()=>{ try{ if(vid.paused){ await vid.play(); } else { vid.pause(); } }catch(e){} };
document.getElementById('back1').onclick=()=>stepFrames(-1);
document.getElementById('fwd1').onclick=()=>stepFrames(1);
document.getElementById('back10').onclick=()=>stepFrames(-10);
document.getElementById('fwd10').onclick=()=>stepFrames(10);
invertBtn.onclick=()=>{ state.invert=!state.invert; draw(); };
document.getElementById('snap').onclick=()=>{
  const dataURL=cvs.toDataURL('image/png');
  const mKey=state.curMoment, m=state.moments[mKey];
  m.snapshots.push({dataURL,when:new Date().toISOString(),frame:m.frame,t:m.t});
  m.captured=true; renderTabs();
  const gobj = m.guides; Object.keys(gobj).forEach(k => { if(gobj[k] && gobj[k].on) gobj[k].on = false; });
  placingActive=false; dragging=null; dragKey=null; hideMag(); draw();
  const idx = MOMENTS.findIndex(mm=>mm.key===mKey);
  if(idx < MOMENTS.length - 1){ setMoment(MOMENTS[idx+1].key); } else { alert('Ya podés generar el reporte.'); }
};
notesEl.oninput=()=>{ state.moments[state.curMoment].notes=notesEl.value; };
fpsInput.onchange=()=>{ state.fps=Number(fpsInput.value)||240; updateTimeUI(); };

/* ===== Reporte ===== */
function computeNeeds(){
  const answers=[];
  function pushMoment(key){ const arr=state.moments[key].checks; for(let i=0;i<arr.length;i++){ answers.push(arr[i]); } }
  pushMoment('toeoff'); pushMoment('mvp'); pushMoment('lateswing'); pushMoment('touchdown'); pushMoment('midstance');
  const groups={
    'Control lumbopélvico':[2,4,7],
    'Back-side mechanics':[1,3,5,8],
    'Overstriding':[6,9,10,11,12]
  };
  const tally={};
  for(const [name, idxs] of Object.entries(groups)){
    tally[name]=idxs.reduce((s,i)=> s + (answers[i-1]?1:0), 0);
  }
  const max = Math.max(...Object.values(tally));
  const winners = Object.keys(tally).filter(k=>tally[k]===max && max>0);
  return {tally, winners, max};
}

document.getElementById('printReport').onclick=()=>{
  const container=document.getElementById('reportContent'); container.innerHTML='';
  const total=Object.values(state.moments).reduce((acc,mm)=> acc + mm.checks.filter(Boolean).length, 0);
  const grade=GRADE(total);
  const needs=computeNeeds();

  const page1=document.createElement('div'); page1.className='page';
  const coverHTML=`
    <div style="display:flex;align-items:center;gap:10px">
      <svg width="44" height="44" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#0f2a44"/><stop offset="1" stop-color="#2b5178"/></linearGradient></defs>
        <circle cx="32" cy="32" r="30" fill="url(#g)"/>
        <path d="M16 38 L28 26 L36 34 L48 22" stroke="#ff7a00" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <div>
        <h1 style="margin:0;font-size:20px">S-MAS • Sprint Mechanics Assessment</h1>
        <div style="font-size:12px;color:#444"><strong>Desarrollado por Santiago Grosso – S-MAS Project</strong></div>
        <div style="font-size:11px;color:#666"><em>Reporte automatizado desarrollado por Santiago Grosso</em></div>
      </div>
    </div>
    <div style="margin-top:10px;font-size:15px"><strong>Puntaje total:</strong> ${total}</div>
    <div style="font-size:15px"><strong>Clasificación:</strong> ${grade}</div>
    <div class="needBox" style="margin-top:8px">
      <div><strong>Área de mayor necesidad:</strong> ${needs.winners.length? needs.winners.join(' · ') : '—'}</div>
      <div style="margin-top:4px; font-size:11px">
        <strong>Criterios:</strong>
        Control lumbopélvico → 2,4,7 · Back-side mechanics → 1,3,5,8 · Overstriding → 6,9,10,11,12
      </div>
    </div>
  `;
  const coverDiv=document.createElement('div'); coverDiv.innerHTML=coverHTML; page1.appendChild(coverDiv);

  const blocks=[];
  MOMENTS.forEach(m=>{
    const mm=state.moments[m.key]; const latest=mm.snapshots[mm.snapshots.length-1];
    const checks=(QUESTIONS[m.key]||[]).map((q,i)=>`<li>${mm.checks[i]?'✅':'⬜️'} ${q}</li>`).join('');
    const notes = mm.notes ? `<div class="notes"><strong>Notas:</strong> ${mm.notes.replace(/</g,'&lt;')}</div>` : '';
    const img = latest ? `<img src="${latest.dataURL}" alt="${m.label}" />` : `<div style="color:#666;padding:12px;border:1px dashed #ccc;border-radius:6px;background:#fafafa">Sin captura</div>`;
    const block=document.createElement('div'); block.className='momentBlock';
    block.innerHTML=`
      <h2 style="margin:3mm 0 1mm 0;">${m.label}</h2>
      <div class="row">
        ${img}
        <div class="col">
          <strong>Checklist</strong>
          <ul>${checks}</ul>
          ${notes}
        </div>
      </div>
    `;
    blocks.push(block);
  });
  if(blocks.length){ page1.appendChild(blocks[0]); }
  container.appendChild(page1);

  const page2=document.createElement('div'); page2.className='page';
  if(blocks[1]) page2.appendChild(blocks[1]);
  if(blocks[2]) page2.appendChild(blocks[2]);
  container.appendChild(page2);

  const page3=document.createElement('div'); page3.className='page';
  if(blocks[3]) page3.appendChild(blocks[3]);
  if(blocks[4]) page3.appendChild(blocks[4]);
  container.appendChild(page3);

  window.print();
};

/* ===== Pantalla completa (Zoom) — único bloque ===== */
const fsBtn = document.getElementById('fs');
const viewArea = document.getElementById('viewArea');

function isFullscreen(){
  return !!(document.fullscreenElement || document.webkitFullscreenElement);
}
async function enterFullscreen(el){
  try{
    if(el && el.requestFullscreen){ await el.requestFullscreen(); }
    else if(el && el.webkitRequestFullscreen){ el.webkitRequestFullscreen(); }
  }catch(e){}
}
async function exitFullscreen(){
  try{
    if(document.exitFullscreen){ await document.exitFullscreen(); }
    else if(document.webkitExitFullscreen){ document.webkitExitFullscreen(); }
  }catch(e){}
}
if (fsBtn){
  fsBtn.onclick = async () => {
    if(!isFullscreen()){ await enterFullscreen(viewArea || wrap); }
    else { await exitFullscreen(); }
  };
  function refreshFsLabel(){ fsBtn.textContent = isFullscreen() ? 'Salir zoom' : 'Zoom'; }
  document.addEventListener('fullscreenchange', refreshFsLabel);
  document.addEventListener('webkitfullscreenchange', refreshFsLabel);
  refreshFsLabel();
}

/* ===== Init ===== */
document.getElementById('clearState').onclick=()=>{
  if(confirm('¿Borrar progreso de esta sesión?')){
    state={fps:240,invert:false,curMoment:'toeoff', moments:Object.fromEntries(MOMENTS.map(m=>[m.key,{
      t:0,frame:0,notes:'',checks:(QUESTIONS[m.key]||[]).map(()=>false), snapshots:[], captured:false, guides:{}
    }]))};
    renderTabs(); setMoment('toeoff'); fpsInput.value=state.fps;
  }
};
file.onchange=()=>{
  const f=file.files[0]; if(!f) return;
  const url=URL.createObjectURL(f); vid.src=url; vid.load();
  vid.onloadedmetadata=()=>{ const r=wrap.getBoundingClientRect(); cvs.width=r.width; cvs.height=r.height; vid.currentTime=0.001; updateTimeUI(); };
};
(function init(){ renderTabs(); setMoment(state.curMoment); fpsInput.value=state.fps; updateReportAvailability(); })();
</script>
