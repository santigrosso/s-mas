<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<title>S-MAS • v3.5.6r (resiliente)</title>
<style>
  :root{ --bg:#0b1b2b; --fg:#ffffff; --acc:#ff7a00; --mut:#b8c3cf; --panel:#11263b; --ok:#19b36a; --bad:#e74c3c; --disabled:#5f6e7d; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  *, *::before, *::after { -webkit-tap-highlight-color: transparent; }
  header{padding:12px 16px;border-bottom:1px solid #163551;display:flex;gap:12px;align-items:center}
  header h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.2px}
  header .pill{background:var(--panel);padding:6px 10px;border-radius:8px;font-size:12px}
  main{display:grid;grid-template-columns:1fr;gap:10px;padding:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid #163551;border-radius:12px;padding:10px;position:relative}
  #videoWrap{position:relative;max-width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden}
  video{position:relative;z-index:1;width:100%;height:100%;display:block;object-fit:contain;background:#000}
  canvas{position:absolute;left:0;top:0;z-index:2;touch-action:none;-webkit-user-select:none;user-select:none}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{background:var(--acc);color:#000;border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;color:var(--fg);border:1px solid #335b87}
  button.small{padding:6px 8px;border-radius:8px;font-weight:600}
  button[disabled]{opacity:.55; cursor:not-allowed; background:var(--disabled)!important; color:#222!important; border-color:transparent!important}
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
  .tab{padding:8px 10px;border-radius:10px;background:#0f2a44;border:1px solid #204667;cursor:pointer;font-size:13px}
  .tab.active{background:var(--acc);color:#000;border-color:var(--acc)}
  .tab.complete{background:var(--ok);color:#000;border-color:var(--ok)}
  .grid{display:grid;grid-template-columns:1fr;gap:8px}
  .q{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;background:#0f2a44;border-radius:8px;border:1px solid #204667}
  .switch{position:relative;width:48px;height:28px;flex:0 0 auto}
  .switch input{opacity:0;position:absolute;inset:0;margin:0}
  .slider{position:absolute;inset:0;background:#6b7b8a;border-radius:14px;transition:.2s}
  .slider::before{content:"";position:absolute;left:3px;top:3px;width:22px;height:22px;background:#fff;border-radius:50%;transition:.2s}
  .switch input:checked + .slider{background:#34c759}
  .switch input:checked + .slider::before{transform:translateX(20px)}
  .q-guide{display:flex;align-items:center;gap:8px;padding:8px;background:#0b2339;border-radius:8px;border:1px solid #1b3b5a}
  .q-guide input[type="checkbox"]{width:18px;height:18px;accent-color:#ff7a00}
  .q-guide label{flex:1;cursor:pointer}
  .score{font-weight:800}
  .label{font-size:12px;color:var(--mut)}
  .hr{height:1px;background:#173a5d;margin:10px 0}
  #report{display:none;background:#fff;color:#000;padding:12px}
  #report .page{break-inside:avoid;border:1px solid #ddd;border-radius:8px;padding:8px;margin:8px 0}
  @media print { header, #app, footer { display:none } #report{display:block} body{background:#fff} }
  .scrub{display:flex;align-items:center;gap:8px;margin-top:6px}
  input[type="range"]{width:100%}
  .moment-desc{font-size:12px;color:#b8c3cf;margin:-4px 0 6px}
  footer{padding:10px 14px;color:#9fb1c4;font-size:12px;text-align:center;border-top:1px solid #163551}
  .diagnose{font-size:12px;color:#9fb1c4}
  .mini{border:1px solid #335b87;border-radius:6px;background:#0b2339;padding:6px}
  .err{color:#ffb4b4}
</style>
</head>
<body>
<header>
  <h1>S-MAS • Sprint Mechanics Assessment</h1>
  <span class="pill">v3.5.6r</span>
  <span class="pill">Local • Offline</span>
</header>

<div id="app">
  <main>
    <div class="row">
      <div class="card" style="flex:2 1 580px">
        <div class="tabs" id="tabs"></div>
        <div class="moment-desc" id="momentDesc"></div>

        <div class="controls" style="justify-content:space-between;margin-bottom:8px">
          <div class="controls">
            <input id="file" type="file" accept="video/*" />
            <button class="ghost small" id="clearState">Limpiar</button>
          </div>
          <div class="controls">
            <span class="label">fps objetivo</span>
            <input id="fps" type="number" value="240" min="1" max="480" style="width:80px;background:#0f2a44;color:#fff;border:1px solid #204667;border-radius:8px;padding:6px"/>
          </div>
        </div>

        <div id="videoWrap">
          <video id="vid" playsinline webkit-playsinline muted controls preload="metadata"></video>
          <canvas id="overlay"></canvas>
        </div>

        <div class="scrub">
          <span class="pill">t=<span id="ctime">0.000</span>s</span>
          <input id="scrub" type="range" min="0" max="0" step="0.001" value="0">
          <span class="pill">frame <b id="fnum">0</b></span>
        </div>

        <div class="controls" style="margin-top:8px;flex-wrap:wrap">
          <button id="play" class="small">▶︎ Play/Pause</button>
          <button id="back1" class="small">−1 frame</button>
          <button id="fwd1" class="small">+1 frame</button>
          <button id="back10" class="small">−10</button>
          <button id="fwd10" class="small">+10</button>
        </div>

        <div class="diagnose mini" style="margin-top:8px">
          <div><b>Diagnóstico</b> (si algo no responde, mirá aquí errores en rojo)</div>
          <div>readyState: <span id="dg-ready">?</span> • hasFrame: <span id="dg-frame">?</span> • last: <span id="dg-last">—</span></div>
          <div class="err" id="dg-error"></div>
        </div>

      </div>

      <div class="card" style="flex:1 1 360px">
        <div class="grid" style="gap:10px">
          <div>
            <strong>Guías</strong>
            <div id="templatesPanel" class="grid" style="margin-top:6px"></div>
            <div class="controls" style="margin-top:6px">
              <button id="invert" class="small">Invertir guías (izq/der)</button>
            </div>
          </div>

          <div class="hr"></div>

          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <strong>Checklist del momento</strong>
              <span class="label">toca el switch</span>
            </div>
            <div id="questions" class="grid"></div>
            <div class="controls" style="margin-top:6px">
              <button id="snap" class="small">Capturar imagen y continuar ➜</button>
            </div>
          </div>

          <div class="hr"></div>
          <div class="grid">
            <div><span class="label">Puntaje del momento</span><div class="score" id="momentScore">0</div></div>
            <div><span class="label">Puntaje total</span><div class="score" id="totalScore">0</div></div>
            <div><span class="label">Clasificación</span><div class="score" id="grade">—</div></div>
          </div>

          <div class="hr"></div>
          <div class="grid">
            <label class="label">Notas del momento</label>
            <textarea id="notes" rows="4" style="width:100%;background:#0f2a44;color:#fff;border:1px solid #204667;border-radius:8px;padding:8px"></textarea>
          </div>

          <div class="hr"></div>
          <div class="grid">
            <button id="printReport" disabled>Generar reporte (Imprimir → PDF)</button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<div id="report">
  <h1 style="font-size:18px;margin:.2em 0">Reporte S-MAS</h1>
  <div id="reportContent"></div>
</div>

<footer>Desarrollado por Santiago Grosso</footer>

<script>
(function(){
  const SHOWERR = (msg)=>{ const el=document.getElementById('dg-error'); if(el) el.textContent=String(msg); };
  window.addEventListener('error', e=>SHOWERR(e.error||e.message||e));
  window.addEventListener('unhandledrejection', e=>SHOWERR('Promise: '+(e.reason||e)));

  const MOMENTS=[
    {key:'toeoff',label:'Toe-off'},
    {key:'mvp',label:'Max Vertical Projection'},
    {key:'lateswing',label:'Late Swing'},
    {key:'touchdown',label:'Touchdown'},
    {key:'midstance',label:'Mid-stance'},
  ];
  const DESCRIPTIONS={
    toeoff:"Punto inmediatamente anterior a que el pie contralateral deje el suelo.",
    mvp:"Punto intermedio entre el toe-off y el touch-down; la pelvis está en su punto más alto de la fase de swing.",
    lateswing:"Punto de máxima extensión de rodilla durante la fase de swing.",
    touchdown:"Punto de primer contacto con el suelo.",
    midstance:"Mitad del apoyo (para referencia de guía específica)."
  };
  const QUESTIONS={
    toeoff:["¿Demasiada extensión de cadera?"],
    mvp:["¿Rotación excesiva de tronco?","¿Está el talón de la pierna trasera por encima de la pantorrilla?"],
    lateswing:["¿Anteversión pélvica o extensión lumbar entre MVP y Late swing?","¿Está la rodilla por detrás de los glúteos?"],
    touchdown:["¿Está el tronco inclinado hacia delante?","¿Hay anteversión pélvica o extensión lumbar?","¿Hay más de 20° entre ambos muslos?","¿Está el pie muy adelantado en relación al CdG?","¿La tibia está inclinada?","¿El primer apoyo es muy marcado con talón o punta?"],
    midstance:["¿Está la rodilla por delante de la punta del pie?"]
  };
  const TEMPLATE_OPTIONS={
    toeoff:[{key:'to_cross45',label:'Cruz (vertical + 45°)'}],
    mvp:[{key:'mvp_vh',label:'Vertical + horizontal'}],
    lateswing:[{key:'ls_vh',label:'Vertical + horizontal'}],
    touchdown:[
      {key:'td_ankleVert',label:'Vertical en tobillo'},
      {key:'td_cross15',label:'Cruz 15° vs vertical (cadera)'},
      {key:'td_angle3',label:'Ángulo 3 puntos (muslos)'}
    ],
    midstance:[{key:'ms_short',label:'Vertical corta en punta del pie'}]
  };

  const $=s=>document.querySelector(s);
  const file=$('#file'), vid=$('#vid'), wrap=$('#videoWrap');
  const cvs=$('#overlay'), ctx=cvs.getContext('2d',{willReadFrequently:true});
  const fpsInput=$('#fps'), ctime=$('#ctime'), fnum=$('#fnum');
  const scrub=$('#scrub');
  const tabs=$('#tabs'), questions=$('#questions'), templatesPanel=$('#templatesPanel');
  const momentScoreEl=$('#momentScore'), totalScoreEl=$('#totalScore'), gradeEl=$('#grade');
  const momentDesc=$('#momentDesc'); const notesEl=$('#notes');
  const btnSnap=$('#snap'), btnInvert=$('#invert'), btnReport=$('#printReport'), btnClear=$('#clearState');
  const dgReady=$('#dg-ready'), dgFrame=$('#dg-frame'), dgLast=$('#dg-last');

  function defaultState(){
    return {
      fps:240, invert:false, curMoment:'toeoff',
      completed:{toeoff:false,mvp:false,lateswing:false,touchdown:false,midstance:false},
      moments: Object.fromEntries(MOMENTS.map(m=>[m.key,{
        t:0, frame:0, notes:'', checks: QUESTIONS[m.key].map(()=>false),
        anchor:{x:200,y:140}, ankle:{x:260,y:200},
        angle3:{p0:null,p1:null,p2:null, val:null, over20:false},
        overlays: Object.fromEntries((TEMPLATE_OPTIONS[m.key]||[]).map(opt=>[opt.key,false])),
        snapshots:[]
      }]))
    };
  }

  const STORAGE_KEY='smas_state_v3_5_6r';
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return defaultState();
      const obj = JSON.parse(raw);
      if (!obj || typeof obj!=='object' || !obj.moments) throw new Error('schema');
      return obj;
    }catch(e){
      SHOWERR('Estado reseteado (almacenamiento corrupto)');
      const fresh = defaultState();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(fresh));
      return fresh;
    }
  }
  function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ SHOWERR('No se pudo guardar estado'); } }

  let state = loadState();
  function currentMoment(){ return state.moments[state.curMoment]; }
  function allCompleted(){ return Object.values(state.completed).every(Boolean); }
  function updateReportAvailability(){ btnReport.disabled = !allCompleted(); }

  function setMoment(key){
    state.curMoment=key; save();
    renderTabs();
    momentDesc.textContent=DESCRIPTIONS[key]||'';
    renderTemplatesPanel();
    renderQuestions();
    notesEl.value=state.moments[key].notes||'';
    draw();
  }
  function renderTabs(){
    tabs.innerHTML='';
    MOMENTS.forEach(m=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='tab'+(state.curMoment===m.key?' active':'')+(state.completed[m.key]?' complete':'');
      b.textContent=m.label; b.dataset.key=m.key;
      b.addEventListener('click',()=>setMoment(m.key),{passive:true});
      tabs.appendChild(b);
    });
  }
  function renderTemplatesPanel(){
    const opts=TEMPLATE_OPTIONS[state.curMoment]||[];
    const m=currentMoment();
    templatesPanel.innerHTML='';
    if(!opts.length){ const p=document.createElement('div'); p.className='label'; p.textContent='Sin guías disponibles para este momento.'; templatesPanel.appendChild(p); return; }
    opts.forEach(opt=>{
      const row=document.createElement('div'); row.className='q-guide';
      const id=`g_${opt.key}`;
      const chk=document.createElement('input'); chk.type='checkbox'; chk.id=id; chk.checked=!!m.overlays[opt.key];
      const lab=document.createElement('label'); lab.setAttribute('for', id); lab.textContent=opt.label;
      chk.addEventListener('change',()=>{ m.overlays[opt.key]=chk.checked; save(); draw(); },{passive:true});
      row.appendChild(chk); row.appendChild(lab);
      templatesPanel.appendChild(row);
    });
  }
  function renderQuestions(){
    const m=currentMoment();
    questions.innerHTML='';
    QUESTIONS[state.curMoment].forEach((q,i)=>{
      const row=document.createElement('div'); row.className='q';
      const lab=document.createElement('div'); lab.textContent=q; lab.style.flex='1';
      const sw=document.createElement('label'); sw.className='switch';
      const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=!!m.checks[i];
      const slider=document.createElement('span'); slider.className='slider';
      chk.addEventListener('change',()=>{ m.checks[i]=chk.checked; save(); refreshScores(); },{passive:true});
      sw.appendChild(chk); sw.appendChild(slider);
      row.appendChild(lab); row.appendChild(sw);
      questions.appendChild(row);
    });
    refreshScores();
  }
  function GRADE(score){
    if(score<=1) return "Excelente (0–1)";
    if(score===2) return "Bueno (2)";
    if(score>=3 && score<=5) return "Promedio (3–5)";
    if(score===6) return "Pobre (6)";
    if(score>=7 && score<=11) return "Muy pobre (7–11)";
    if(score>=12) return "Extremadamente pobre (12)";
    return "—";
  }
  function refreshScores(){
    const ms=Object.values(state.moments).map(m=>m.checks.filter(Boolean).length);
    const cur=currentMoment().checks.filter(Boolean).length;
    const total=ms.reduce((a,b)=>a+b,0);
    momentScoreEl.textContent=cur;
    totalScoreEl.textContent=total;
    gradeEl.textContent=GRADE(total);
  }

  function fitContain(srcW,srcH,dstW,dstH){ const s=Math.min(dstW/srcW,dstH/srcH); const w=srcW*s, h=srcH*s; const x=(dstW-w)/2, y=(dstH-h)/2; return {x,y,w,h,s}; }
  function invertPointToVideoSpace(px,py,fit){ return {x:(px-fit.x)/fit.s, y:(py-fit.y)/fit.s}; }
  function sizeCanvasToWrap(){ const r=wrap.getBoundingClientRect(); cvs.width=r.width; cvs.height=r.height; }
  function getFit(){ return fitContain(vid.videoWidth, vid.videoHeight, cvs.width, cvs.height); }

  function draw(){
    sizeCanvasToWrap(); ctx.clearRect(0,0,cvs.width,cvs.height);
    if(!vid.videoWidth||!vid.videoHeight) return;
    const fit=getFit(); ctx.drawImage(vid,0,0,vid.videoWidth,vid.videoHeight,fit.x,fit.y,fit.w,fit.h); renderOverlaysTo(ctx,fit);
  }
  function renderOverlaysTo(ctx2,fit){
    const m=currentMoment(); const inv=state.invert; const ov=m.overlays||{}; const k=state.curMoment;
    const line=(x1,y1,x2,y2,dash=[],color='white',w=2)=>{ ctx2.save(); ctx2.setLineDash(dash); ctx2.lineWidth=w; ctx2.strokeStyle=color; ctx2.beginPath(); ctx2.moveTo(fit.x+x1*fit.s,fit.y+y1*fit.s); ctx2.lineTo(fit.x+x2*fit.s,fit.y+y2*fit.s); ctx2.stroke(); ctx2.restore(); };
    const dot=(x,y,color='white',r=4)=>{ ctx2.save(); ctx2.fillStyle=color; ctx2.beginPath(); ctx2.arc(fit.x+x*fit.s,fit.y+y*fit.s,r,0,Math.PI*2); ctx2.fill(); ctx2.restore(); };
    const ang=(p0,p1,p2)=>{ const v1={x:p0.x-p1.x,y:p0.y-p1.y}, v2={x:p2.x-p1.x,y:p2.y-p1.y}; const d1=Math.hypot(v1.x,v1.y)||1, d2=Math.hypot(v2.x,v2.y)||1; const c=(v1.x*v2.x+v1.y*v2.y)/(d1*d2); return Math.acos(Math.min(1,Math.max(-1,c)))*180/Math.PI; };
    const H=vid.videoHeight, W=vid.videoWidth;

    if(k==='toeoff'&&ov.to_cross45){
      line(m.anchor.x,0,m.anchor.x,H);
      const a=(inv?-1:1)*(45*Math.PI/180), len=Math.max(W,H);
      line(m.anchor.x-Math.cos(a)*len, m.anchor.y+Math.sin(a)*len, m.anchor.x+Math.cos(a)*len, m.anchor.y-Math.sin(a)*len,[6,4]);
      dot(m.anchor.x,m.anchor.y);
    }
    if(k==='mvp'&&ov.mvp_vh){ line(m.anchor.x,0,m.anchor.x,H); line(0,m.anchor.y,W,m.anchor.y); dot(m.anchor.x,m.anchor.y); }
    if(k==='lateswing'&&ov.ls_vh){ line(m.anchor.x,0,m.anchor.x,H); line(0,m.anchor.y,W,m.anchor.y); dot(m.anchor.x,m.anchor.y); }
    if(k==='touchdown'){
      if(ov.td_ankleVert){ line(m.ankle.x,0,m.ankle.x,H,[4,4],'rgba(255,255,255,.7)'); dot(m.ankle.x,m.ankle.y||m.ankle.x); }
      if(ov.td_cross15){
        line(m.anchor.x,0,m.anchor.x,H);
        const a=(inv?-1:1)*(75*Math.PI/180), len=Math.max(W,H);
        line(m.anchor.x-Math.cos(a)*len, m.anchor.y+Math.sin(a)*len, m.anchor.x+Math.cos(a)*len, m.anchor.y-Math.sin(a)*len,[6,4]);
        dot(m.anchor.x,m.anchor.y);
      }
      if(ov.td_angle3){
        const {p0,p1,p2}=m.angle3; if(p0)dot(p0.x,p0.y); if(p1)dot(p1.x,p1.y); if(p2)dot(p2.x,p2.y);
        if(p0&&p1&&p2){ line(p1.x,p1.y,p0.x,p0.y); line(p1.x,p1.y,p2.x,p2.y); const a2=ang(p0,p1,p2); m.angle3.val=a2; m.angle3.over20=a2>20; save(); ctx2.save(); ctx2.fillStyle=a2>20?'rgba(231,76,60,.9)':'rgba(25,179,106,.9)'; ctx2.font='bold 14px system-ui'; ctx2.fillText(`${a2.toFixed(1)}°`, fit.x+p1.x*fit.s+8, fit.y+p1.y*fit.s-8); ctx2.restore(); if(a2>20){ ctx2.save(); ctx2.strokeStyle='rgba(231,76,60,1)'; ctx2.lineWidth=4; ctx2.beginPath(); ctx2.arc(fit.x+p1.x*fit.s, fit.y+p1.y*fit.s, 24, 0, Math.PI*2); ctx2.stroke(); ctx2.restore(); } }
      }
    }
    if(k==='midstance'&&ov.ms_short){ const hh=vid.videoHeight*0.12; line(m.anchor.x,m.anchor.y-hh/2,m.anchor.x,m.anchor.y+hh/2,[], 'rgba(255,255,255,.85)',3); dot(m.anchor.x,m.anchor.y); }
  }

  function updateTimeUI(){
    ctime.textContent=(vid.currentTime||0).toFixed(3);
    const fps=Number(state.fps)||240;
    const frame=Math.round((vid.currentTime||0)*fps);
    fnum.textContent=frame;
    scrub.max=vid.duration||0; scrub.value=vid.currentTime||0;
    const m=currentMoment(); m.t=vid.currentTime||0; m.frame=frame; save();
    dgReady.textContent=String(vid.readyState);
    dgFrame.textContent=String(!!vid.videoWidth);
  }
  function stepFrames(n){ const fps=Number(state.fps)||240; vid.pause(); const dt=n/fps; const t=Math.max(0, Math.min(vid.duration||0, (vid.currentTime||0)+dt)); vid.currentTime=t; }
  vid.addEventListener('timeupdate',()=>{ updateTimeUI(); draw(); });
  vid.addEventListener('seeked',()=>{ updateTimeUI(); draw(); });
  vid.addEventListener('loadeddata',()=>{ updateTimeUI(); draw(); });
  window.addEventListener('resize',draw);
  scrub.addEventListener('input',()=>{ vid.currentTime=Number(scrub.value)||0; });

  let dragging=null;
  function toVideoSpace(ev){ const r=cvs.getBoundingClientRect(); const px=(ev.touches?ev.touches[0].clientX:ev.clientX)-r.left; const py=(ev.touches?ev.touches[0].clientY:ev.clientY)-r.top; const fit=getFit(); return invertPointToVideoSpace(px,py,fit); }
  function hit(pt,x,y){ return pt && Math.hypot(pt.x-x, pt.y-y) < 16; }
  function pointerDownAt(x,y){
    const k=state.curMoment, m=currentMoment(), ov=m.overlays||{};
    if(k==='toeoff'&&ov.to_cross45){ dragging='anchor'; return; }
    if(k==='mvp'&&ov.mvp_vh){ dragging='anchor'; return; }
    if(k==='lateswing'&&ov.ls_vh){ dragging='anchor'; return; }
    if(k==='midstance'&&ov.ms_short){ dragging='anchor'; return; }
    if(k==='touchdown'){
      if(ov.td_angle3){
        if(!m.angle3.p0){ m.angle3.p0={x,y}; save(); draw(); return; }
        if(!m.angle3.p1){ m.angle3.p1={x,y}; save(); draw(); return; }
        if(!m.angle3.p2){ m.angle3.p2={x,y}; save(); draw(); return; }
        if(hit(m.angle3.p0,x,y)){ dragging='p0'; return; }
        if(hit(m.angle3.p1,x,y)){ dragging='p1'; return; }
        if(hit(m.angle3.p2,x,y)){ dragging='p2'; return; }
      }
      if(ov.td_ankleVert && hit(m.ankle,x,y)){ dragging='ankle'; return; }
      if(ov.td_cross15 && hit(m.anchor,x,y)){ dragging='anchor'; return; }
      if(ov.td_cross15){ dragging='anchor'; return; }
    }
    dragging=null;
  }
  function pointerMoveTo(x,y){
    if(!dragging) return;
    const m=currentMoment();
    if(dragging==='anchor') m.anchor={x,y};
    if(dragging==='ankle') m.ankle={x,y};
    if(dragging==='p0') m.angle3.p0={x,y};
    if(dragging==='p1') m.angle3.p1={x,y};
    if(dragging==='p2') m.angle3.p2={x,y};
    save(); draw();
  }
  const onTouchStart=(ev)=>{ const {x,y}=toVideoSpace(ev); pointerDownAt(x,y); ev.preventDefault(); };
  const onTouchMove=(ev)=>{ if(!dragging) return; const {x,y}=toVideoSpace(ev); pointerMoveTo(x,y); ev.preventDefault(); };
  const onTouchEnd=()=>{ dragging=null; };
  const onMouseDown=(ev)=>{ const p=toVideoSpace(ev); pointerDownAt(p.x,p.y); };
  const onMouseMove=(ev)=>{ if(!dragging) return; const p=toVideoSpace(ev); pointerMoveTo(p.x,p.y); };
  const onMouseUp=()=>{ dragging=null; };

  cvs.addEventListener('touchstart', onTouchStart, {passive:false});
  cvs.addEventListener('touchmove', onTouchMove, {passive:false});
  cvs.addEventListener('touchend', onTouchEnd, {passive:false});
  cvs.addEventListener('mousedown', onMouseDown);
  cvs.addEventListener('mousemove', onMouseMove);
  cvs.addEventListener('mouseup', onMouseUp);
  cvs.addEventListener('mouseleave', onMouseUp);

  async function waitForStableFrame(){
    return new Promise(res=>{
      if ('requestVideoFrameCallback' in HTMLVideoElement.prototype){
        vid.requestVideoFrameCallback(()=>{ requestAnimationFrame(()=>res()); });
      } else {
        requestAnimationFrame(()=>requestAnimationFrame(res));
      }
    });
  }
  async function captureCompat(){
    if (vid.readyState < 2){ await new Promise(r=>vid.addEventListener('loadeddata', r, {once:true})); }
    if (!vid.paused) vid.pause();
    await waitForStableFrame();
    const prevControls = vid.controls, prevVis = vid.style.visibility;
    vid.controls=false; vid.style.visibility='hidden'; void vid.offsetWidth;
    const vw=vid.videoWidth, vh=vid.videoHeight;
    const tmp=document.createElement('canvas'); tmp.width=vw; tmp.height=vh;
    const tctx=tmp.getContext('2d',{willReadFrequently:true});
    tctx.drawImage(vid,0,0,vw,vh);
    renderOverlaysTo(tctx,{x:0,y:0,w:vw,h:vh,s:1});
    vid.style.visibility=prevVis||'visible'; vid.controls=prevControls;
    return tmp.toDataURL('image/png');
  }

  $('#play').addEventListener('click', async ()=>{ try{ if(vid.paused){ await vid.play(); } else { vid.pause(); } } catch(e){ SHOWERR(e);} }, {passive:true});
  $('#back1').addEventListener('click', ()=>stepFrames(-1),{passive:true});
  $('#fwd1').addEventListener('click', ()=>stepFrames(1),{passive:true});
  $('#back10').addEventListener('click', ()=>stepFrames(-10),{passive:true});
  $('#fwd10').addEventListener('click', ()=>stepFrames(10),{passive:true});
  btnInvert.addEventListener('click', ()=>{ state.invert=!state.invert; save(); draw(); },{passive:true});
  btnSnap.addEventListener('click', async ()=>{
    try{
      const dataURL = await captureCompat();
      const m=currentMoment();
      m.snapshots.push({dataURL, when:new Date().toISOString(), frame:m.frame, t:m.t});
      state.completed[state.curMoment]=true; save(); renderTabs(); updateReportAvailability();
      const idx=MOMENTS.findIndex(mm=>mm.key===state.curMoment); const next=MOMENTS[idx+1]; if(next) setMoment(next.key);
      dgLast.textContent='capt ok';
    }catch(err){ dgLast.textContent='capt err'; SHOWERR(err); alert('No se pudo capturar. En iPad: Pausar ▶︎ y volver a intentar.'); }
  },{passive:true});

  btnReport.addEventListener('click', ()=>{
    const cont=document.getElementById('reportContent'); cont.innerHTML='';
    MOMENTS.forEach(m=>{
      const mm=state.moments[m.key]; const latest=mm.snapshots[mm.snapshots.length-1];
      const checks=QUESTIONS[m.key].map((q,i)=>`<li>${mm.checks[i]?'✅':'⬜️'} ${q}</li>`).join('');
      const ms=mm.checks.filter(Boolean).length;
      const page=document.createElement('div'); page.className='page';
      page.innerHTML=`<h2>${m.label}</h2>
      <div><small>t=${(mm.t||0).toFixed(3)}s • frame ${mm.frame||0}</small></div>
      ${latest? `<div><img src="${latest.dataURL}" alt="${m.label}" style="max-width:100%"/></div>` : `<div style="color:#666;padding:12px;border:1px dashed #ccc;border-radius:8px">Sin captura</div>`}
      <div style="margin-top:6px"><strong>Puntaje del momento:</strong> ${ms}</div>
      <div><strong>Checklist</strong><ul>${checks}</ul></div>
      ${mm.notes? `<div><strong>Notas:</strong> ${mm.notes}</div>`:''}`;
      cont.appendChild(page);
    });
    const total=Object.values(state.moments).reduce((acc,mm)=> acc + mm.checks.filter(Boolean).length,0);
    const sum=document.createElement('div'); sum.className='page';
    sum.innerHTML=`<h2>Resumen</h2><div><strong>Puntaje total:</strong> ${total}</div><div><strong>Clasificación:</strong> ${ (function(score){ if(score<=1) return "Excelente (0–1)"; if(score===2) return "Bueno (2)"; if(score>=3 && score<=5) return "Promedio (3–5)"; if(score===6) return "Pobre (6)"; if(score>=7 && score<=11) return "Muy pobre (7–11)"; if(score>=12) return "Extremadamente pobre (12)"; return "—"; })(total) }</div>`;
    cont.prepend(sum);
    window.print();
  },{passive:true});

  btnClear.addEventListener('click', ()=>{
    if(confirm('¿Borrar trabajo guardado?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); }
  },{passive:true});

  notesEl.addEventListener('input', ()=>{ currentMoment().notes=notesEl.value; save(); },{passive:true});
  fpsInput.addEventListener('change', ()=>{ state.fps=Number(fpsInput.value)||240; save(); updateTimeUI(); },{passive:true});

  file.addEventListener('change', ()=>{
    const f=file.files[0]; if(!f) return;
    const url=URL.createObjectURL(f);
    vid.src=url; vid.load();
    vid.onloadedmetadata=()=>{ const r=wrap.getBoundingClientRect(); cvs.width=r.width; cvs.height=r.height; vid.currentTime=0.001; scrub.max=vid.duration||0; };
  },{passive:true});

  function init(){ renderTabs(); setMoment(state.curMoment); updateReportAvailability(); fpsInput.value=state.fps; }
  try{ init(); }catch(e){ SHOWERR('init: '+e); }
})();
</script>
</body>
</html>