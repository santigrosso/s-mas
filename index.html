<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>S-MAS • Sprint Mechanics Assessment (v3)</title>
<style>
  :root{
    --bg:#0b1b2b; --fg:#ffffff; --acc:#ff7a00; --mut:#b8c3cf; --panel:#11263b; --ok:#19b36a; --bad:#e74c3c;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:12px 16px;border-bottom:1px solid #163551;display:flex;gap:12px;align-items:center;justify-content:space-between}
  header h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.2px}
  .pill{background:var(--panel);padding:6px 10px;border-radius:8px;font-size:12px}
  main{display:grid;grid-template-columns:1fr;gap:10px;padding:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid #163551;border-radius:12px;padding:10px}
  #videoWrap{position:relative;max-width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden}
  video{width:100%;height:100%;display:block;object-fit:contain;background:#000}
  canvas{position:absolute;left:0;top:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{background:var(--acc);color:#000;border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;color:var(--fg);border:1px solid #335b87}
  button.small{padding:6px 8px;border-radius:8px;font-weight:600}
  .tabs{display:flex;gap:6px;flex-wrap:wrap}
  .tab{padding:8px 10px;border-radius:10px;background:#0f2a44;border:1px solid #204667;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:6px}
  .tab.active{background:var(--acc);color:#000;border-color:var(--acc)}
  .tab.done{background:var(--ok);color:#000;border-color:var(--ok)}
  .grid{display:grid;grid-template-columns:1fr;gap:8px}
  .q{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px;background:#0f2a44;border-radius:8px;border:1px solid #204667}
  .score{font-weight:800}
  .label{font-size:12px;color:var(--mut)}
  .hr{height:1px;background:#173a5d;margin:10px 0}
  #report{display:none;background:#fff;color:#000;padding:12px}
  #report h2{margin:.2em 0 .4em;font-size:16px}
  #report .page{break-inside:avoid;border:1px solid #ddd;border-radius:8px;padding:8px;margin:8px 0}
  #report img{max-width:100%}
  @media print { header, #app, footer { display:none } #report{display:block} body{background:#fff} }
  /* Toggle estilo iOS */
  .switch{position:relative;width:48px;height:28px;background:#6a7a8a;border-radius:999px;border:1px solid #3a516a;flex:0 0 auto;cursor:pointer;transition:background .15s ease}
  .switch::after{content:"";position:absolute;top:2px;left:2px;width:24px;height:24px;border-radius:50%;background:#fff;transition:left .15s ease}
  .switch.on{background:#28cf7a;border-color:#28cf7a}
  .switch.on::after{left:22px}
  /* Barra de progreso */
  .seekbar{appearance:none;width:100%;height:8px;border-radius:999px;background:#0f2a44;outline:none;border:1px solid #204667}
  .seekbar::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:var(--acc);border:2px solid #000;margin-top:-5px}
  .seekwrap{display:flex;align-items:center;gap:8px;margin-top:8px}
  .time{font-variant-numeric:tabular-nums}
  footer{padding:12px 16px;color:#9fb2c8;font-size:12px;border-top:1px solid #163551;text-align:center}
  .desc{font-size:13px;color:#cfe0f4;background:#0f2a44;border:1px solid #204667;border-radius:10px;padding:8px}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <h1>S-MAS • Sprint Mechanics Assessment</h1>
    <span class="pill">Local • Offline</span>
    <span class="pill">HEVC / 240 fps</span>
  </div>
  <div class="controls">
    <input id="file" type="file" accept="video/*" />
    <button class="ghost small" id="clearState">Limpiar</button>
  </div>
</header>

<div id="app">
  <main>
    <div class="row">
      <div class="card" style="flex:2 1 560px">
        <!-- Pestañas arriba del video -->
        <div class="tabs" id="tabs"></div>
        <div class="desc" id="momentDesc" style="margin:8px 0 6px">—</div>

        <div id="videoWrap">
          <video id="vid" playsinline muted controls preload="metadata"></video>
          <canvas id="overlay"></canvas>
        </div>

        <!-- Barra de progreso estilo YouTube -->
        <div class="seekwrap">
          <span class="time" id="tcur">0:00</span>
          <input id="seek" class="seekbar" type="range" min="0" max="1000" value="0" />
          <span class="time" id="tmax">0:00</span>
        </div>

        <div class="controls" style="margin-top:8px;flex-wrap:wrap">
          <button id="play" class="small">▶︎ Play/Pause</button>
          <button id="back1" class="small">−1 frame</button>
          <button id="fwd1" class="small">+1 frame</button>
          <button id="back10" class="small">−10</button>
          <button id="fwd10" class="small">+10</button>
          <button id="snap" class="small">Capturar imagen</button>
          <button id="invert" class="small">Invertir plantilla (izq/der)</button>
          <span class="pill">fps <input id="fps" type="number" value="240" min="1" max="480" style="width:70px;background:#0f2a44;color:#fff;border:1px solid #204667;border-radius:8px;padding:6px"/></span>
          <span class="pill">t=<span id="ctime">0.000</span>s • frame <b id="fnum">0</b></span>
          <span class="pill">momento: <b id="curMomentLabel">Toe-off</b></span>
        </div>
      </div>

      <div class="card" style="flex:1 1 320px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong>Checklist del momento</strong>
          <span class="label">deslizar ON/OFF</span>
        </div>
        <div id="questions" class="grid"></div>
        <div class="hr"></div>
        <div class="grid">
          <div><span class="label">Puntaje del momento</span><div class="score" id="momentScore">0</div></div>
          <div><span class="label">Puntaje total</span><div class="score" id="totalScore">0</div></div>
          <div><span class="label">Clasificación</span><div class="score" id="grade">—</div></div>
        </div>
        <div class="hr"></div>
        <div class="grid">
          <label class="label">Notas del momento</label>
          <textarea id="notes" rows="4" style="width:100%;background:#0f2a44;color:#fff;border:1px solid #204667;border-radius:8px;padding:8px"></textarea>
        </div>
        <div class="hr"></div>
        <div class="grid">
          <button id="printReport">Generar reporte (Imprimir → PDF)</button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Reporte imprimible -->
<div id="report">
  <h1 style="font-size:18px;margin:.2em 0">Reporte S-MAS</h1>
  <div id="reportContent"></div>
</div>

<footer>
  Desarrollado por Santiago Grosso – S-MAS Project
</footer>

<script>
/* ========= Estado ========= */
const MOMENTS = [
  {key:'toeoff', label:'Toe-off'},
  {key:'mvp', label:'Max Vertical Projection'},
  {key:'lateswing', label:'Late Swing'},
  {key:'touchdown', label:'Touchdown'},
  {key:'midstance', label:'Mid-stance'},
];
const DESC = {
  toeoff: "Punto inmediatamente anterior a que el pie contralateral deje el suelo.",
  mvp: "Punto intermedio entre Toe-off y Touchdown; la pelvis está en su punto más alto de la fase de swing.",
  lateswing: "Punto de máxima extensión de rodilla durante la fase de swing.",
  touchdown: "Punto de primer contacto con el suelo.",
  midstance: "Punto donde la pelvis está directamente sobre la articulación del tobillo."
};
const QUESTIONS = {
  toeoff: [ "¿Demasiada extensión de cadera?" ],
  mvp: [ "¿Rotación excesiva de tronco?", "¿Está el talón de la pierna trasera por encima de la pantorrilla?" ],
  lateswing: [ "¿Anteversión pélvica o extensión lumbar entre MVP y Late swing?", "¿Está la rodilla por detrás de los glúteos?" ],
  touchdown: [ "¿Está el tronco inclinado hacia delante?","¿Hay anteversión pélvica o extensión lumbar?","¿Hay más de 20° entre ambos muslos?","¿Está el pie muy adelantado en relación al CdG?","¿La tibia está inclinada?","¿El primer apoyo es muy marcado con talón o punta?" ],
  midstance: [ "¿Está la rodilla por delante de la punta del pie?" ]
};
const GRADE = (score)=>{
  if (score<=1) return "Excelente (0–1)";
  if (score===2) return "Bueno (2)";
  if (score>=3 && score<=5) return "Promedio (3–5)";
  if (score===6) return "Pobre (6)";
  if (score>=7 && score<=11) return "Muy pobre (7–11)";
  if (score>=12) return "Extremadamente pobre (12)";
  return "—";
};

let state = JSON.parse(localStorage.getItem('smas_state_v3')||'null') || {
  fps:240, invert:false, curMoment:'toeoff',
  moments: Object.fromEntries(MOMENTS.map(m=>[m.key,{ t:0, frame:0, notes:'', checks: QUESTIONS[m.key].map(()=>false),
    anchor:{x:100,y:100}, ankle:{x:150,y:150}, angle3:{p0:null,p1:null,p2:null, val:null, over20:false},
    snapshots:[], captured:false }]))
};

/* ========= DOM ========= */
const $ = sel=>document.querySelector(sel);
const file=$('#file'), vid=$('#vid'), wrap=$('#videoWrap');
const cvs=$('#overlay'), ctx=cvs.getContext('2d');
const fpsInput=$('#fps'), ctime=$('#ctime'), fnum=$('#fnum');
const tabs=$('#tabs'), questions=$('#questions'), momentScoreEl=$('#momentScore'), totalScoreEl=$('#totalScore'), gradeEl=$('#grade'), curMomentLabel=$('#curMomentLabel');
const notesEl=$('#notes'), momentDesc=$('#momentDesc');
const tcur=$('#tcur'), tmax=$('#tmax'), seek=$('#seek');

function save(){ localStorage.setItem('smas_state_v3', JSON.stringify(state)); }
function setMoment(key){
  state.curMoment = key; save();
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.key===key));
  curMomentLabel.textContent = MOMENTS.find(m=>m.key===key).label;
  momentDesc.textContent = DESC[key] || "—";
  renderQuestions(); notesEl.value = state.moments[key].notes||''; draw();
}
function renderTabs(){
  tabs.innerHTML='';
  MOMENTS.forEach((m,idx)=>{
    const b=document.createElement('button');
    b.className='tab'+(state.curMoment===m.key?' active':'')+(state.moments[m.key].captured?' done':'');
    b.textContent=m.label; b.dataset.key=m.key; b.onclick=()=>setMoment(m.key);
    tabs.appendChild(b);
  });
}
function renderQuestions(){
  const m = state.moments[state.curMoment];
  questions.innerHTML='';
  QUESTIONS[state.curMoment].forEach((q,i)=>{
    const row=document.createElement('div'); row.className='q';
    const lab=document.createElement('div'); lab.textContent=q;
    const sw=document.createElement('div'); sw.className='switch'+(m.checks[i]?' on':'');
    sw.onclick=()=>{ m.checks[i]=!m.checks[i]; sw.classList.toggle('on'); save(); refreshScores(); draw(); };
    row.appendChild(lab); row.appendChild(sw); questions.appendChild(row);
  });
  refreshScores();
}
function refreshScores(){
  const ms = Object.values(state.moments).map(m=>m.checks.filter(Boolean).length);
  const cur = state.moments[state.curMoment].checks.filter(Boolean).length;
  const total = ms.reduce((a,b)=>a+b,0);
  momentScoreEl.textContent = cur; totalScoreEl.textContent = total; gradeEl.textContent = GRADE(total);
}

/* ========= Video & frames ========= */
function sizeCanvasToWrap(){
  const r = wrap.getBoundingClientRect();
  cvs.width = r.width; cvs.height = r.height;
}
function draw(){
  if (!vid.videoWidth) return;
  sizeCanvasToWrap();
  ctx.clearRect(0,0,cvs.width,cvs.height);
  ctx.drawImage(vid, 0,0,cvs.width,cvs.height);
  drawOverlays();
}
function stepFrames(n){
  const fps = Number(state.fps)||240;
  vid.pause();
  const dt = n / fps;
  const t = Math.max(0, Math.min(vid.duration || 0, vid.currentTime + dt));
  vid.currentTime = t;
}
function updateTimeUI(){
  ctime.textContent = (vid.currentTime||0).toFixed(3);
  const fps = Number(state.fps)||240;
  const frame = Math.round((vid.currentTime||0)*fps);
  fnum.textContent = frame;
  const m = state.moments[state.curMoment];
  m.t = vid.currentTime||0; m.frame=frame; save();
  // seekbar
  if (vid.duration) {
    seek.value = Math.round((vid.currentTime/vid.duration)*1000);
    tcur.textContent = fmt(vid.currentTime);
    tmax.textContent = fmt(vid.duration);
  }
}
function fmt(t){ if (!isFinite(t)) return "0:00"; const m=Math.floor(t/60); const s=Math.floor(t%60); return m+":"+(s<10?"0":"")+s; }

vid.addEventListener('timeupdate', ()=>{ updateTimeUI(); draw(); });
vid.addEventListener('seeked', ()=>{ updateTimeUI(); draw(); });
vid.addEventListener('loadeddata', ()=>{ updateTimeUI(); draw(); });
window.addEventListener('resize', draw);

seek.addEventListener('input', ()=>{
  if (!vid.duration) return;
  const target = (seek.value/1000)*vid.duration;
  vid.currentTime = target;
});

/* ========= Interacción overlay ========= */
let dragging=null;
function toCanvasCoords(ev){
  const r=cvs.getBoundingClientRect();
  const x = (ev.touches?ev.touches[0].clientX:ev.clientX) - r.left;
  const y = (ev.touches?ev.touches[0].clientY:ev.clientY) - r.top;
  return {x,y};
}
function hit(pt, x,y){ return pt && Math.hypot(pt.x-x, pt.y-y) < 16; }
function currentMoment(){ return state.moments[state.curMoment]; }
function startDrag(ev){
  const {x,y}=toCanvasCoords(ev);
  const m=currentMoment();
  if (state.curMoment==='touchdown'){
    if (hit(m.angle3.p0||{x:-1,y:-1},x,y)) dragging='p0';
    else if (hit(m.angle3.p1||{x:-1,y:-1},x,y)) dragging='p1';
    else if (hit(m.angle3.p2||{x:-1,y:-1},x,y)) dragging='p2';
    else if (hit(m.ankle,x,y)) dragging='ankle';
    else if (hit(m.anchor,x,y)) dragging='anchor';
    else {
      if (!m.angle3.p0) { m.angle3.p0={x,y}; dragging='p0'; }
      else if (!m.angle3.p1){ m.angle3.p1={x,y}; dragging='p1'; }
      else if (!m.angle3.p2){ m.angle3.p2={x,y}; dragging='p2'; }
      else { m.anchor={x,y}; dragging='anchor'; }
      save();
    }
  } else {
    if (hit(m.anchor,x,y)) dragging='anchor';
    else { m.anchor={x,y}; dragging='anchor'; save(); }
  }
  ev.preventDefault();
}
function moveDrag(ev){
  if (!dragging) return;
  const {x,y}=toCanvasCoords(ev);
  const m=currentMoment();
  if (dragging==='anchor') m.anchor={x,y};
  if (dragging==='ankle')  m.ankle={x,y};
  if (dragging==='p0')     m.angle3.p0={x,y};
  if (dragging==='p1')     m.angle3.p1={x,y};
  if (dragging==='p2')     m.angle3.p2={x,y};
  save(); draw();
  ev.preventDefault();
}
function endDrag(){ dragging=null; }
cvs.addEventListener('mousedown', startDrag);
cvs.addEventListener('mousemove', moveDrag);
cvs.addEventListener('mouseup', endDrag);
cvs.addEventListener('mouseleave', endDrag);
cvs.addEventListener('touchstart', startDrag,{passive:false});
cvs.addEventListener('touchmove', moveDrag,{passive:false});
cvs.addEventListener('touchend', endDrag);

/* ========= Dibujo de plantillas ========= */
function line(x1,y1,x2,y2, dash=[], color='white', width=2){
  ctx.save(); ctx.setLineDash(dash); ctx.lineWidth = width; ctx.strokeStyle = color;
  ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); ctx.restore();
}
function dot(x,y,color='white'){
  ctx.save(); ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill(); ctx.restore();
}
function drawCrossAt(x,y, invert=false, angleDeg=45){
  line(x,0,x,cvs.height,[], 'rgba(255,255,255,.85)');
  const a = (invert? -1: 1) * (angleDeg*Math.PI/180);
  const len = Math.max(cvs.width,cvs.height);
  const dx = Math.cos(a)*len, dy = -Math.sin(a)*len;
  line(x - dx, y + dy, x + dx, y - dy, [6,4], 'rgba(255,255,255,.85)');
  dot(x,y);
}
function drawVHAt(x,y){
  line(x,0,x,cvs.height,[], 'rgba(255,255,255,.85)');
  line(0,y,cvs.width,y,[], 'rgba(255,255,255,.85)');
  dot(x,y);
}
function angleBetween(p0,p1,p2){
  const v1={x:p0.x-p1.x, y:p0.y-p1.y}, v2={x:p2.x-p1.x, y:p2.y-p1.y};
  const d1=Math.hypot(v1.x,v1.y)||1, d2=Math.hypot(v2.x,v2.y)||1;
  const cos = (v1.x*v2.x + v1.y*v2.y)/(d1*d2);
  const ang = Math.acos(Math.min(1,Math.max(-1,cos)))*180/Math.PI;
  return ang;
}
function drawOverlays(){
  const m = currentMoment(); const invert = state.invert;
  if (state.curMoment==='toeoff'){ drawCrossAt(m.anchor.x, m.anchor.y, invert, 45); }
  else if (state.curMoment==='mvp'){ drawVHAt(m.anchor.x, m.anchor.y); }
  else if (state.curMoment==='lateswing'){ drawVHAt(m.anchor.x, m.anchor.y); }
  else if (state.curMoment==='touchdown'){
    line(m.ankle.x, 0, m.ankle.x, cvs.height, [4,4], 'rgba(255,255,255,.7)'); dot(m.ankle.x, m.ankle.y||m.ankle.x);
    drawCrossAt(m.anchor.x, m.anchor.y, invert, 15);
    const {p0,p1,p2}=m.angle3;
    if (p0) dot(p0.x,p0.y); if (p1) dot(p1.x,p1.y); if (p2) dot(p2.x,p2.y);
    if (p0 && p1 && p2){
      line(p1.x,p1.y,p0.x,p0.y,[], '#fff',2); line(p1.x,p1.y,p2.x,p2.y,[], '#fff',2);
      const ang = angleBetween(p0,p1,p2); m.angle3.val = ang; m.angle3.over20 = ang>20; save();
      ctx.save(); ctx.fillStyle = m.angle3.over20 ? 'rgba(231,76,60,.9)' : 'rgba(25,179,106,.9)';
      ctx.font = 'bold 14px system-ui'; ctx.fillText(`${ang.toFixed(1)}°`, p1.x+8, p1.y-8); ctx.restore();
      if (m.angle3.over20){ ctx.save(); ctx.strokeStyle='rgba(231,76,60,1)'; ctx.lineWidth=4; ctx.beginPath(); ctx.arc(p1.x,p1.y,24,0,Math.PI*2); ctx.stroke(); ctx.restore(); }
    }
  } else if (state.curMoment==='midstance'){
    const h = cvs.height*0.12; line(m.anchor.x, m.anchor.y-h/2, m.anchor.x, m.anchor.y+h/2, [], 'rgba(255,255,255,.85)', 3); dot(m.anchor.x, m.anchor.y);
  }
  // Indicador: arrastrar
  ctx.save(); ctx.fillStyle='rgba(255,255,255,.6)'; ctx.font='12px system-ui';
  ctx.fillText('Arrastrá los puntos para posicionar las plantillas', 10, cvs.height-10); ctx.restore();
}

/* ========= Acciones ========= */
$('#play').onclick = async ()=>{ try{ if (vid.paused) await vid.play(); else vid.pause(); }catch(e){} };
$('#back1').onclick = ()=>stepFrames(-1);
$('#fwd1').onclick  = ()=>stepFrames(1);
$('#back10').onclick= ()=>stepFrames(-10);
$('#fwd10').onclick = ()=>stepFrames(10);
$('#invert').onclick= ()=>{ state.invert=!state.invert; save(); draw(); };

// Capturar imagen: guarda + marca pestaña done + avanza al siguiente momento (sin descargar)
$('#snap').onclick  = ()=>{
  const dataURL = cvs.toDataURL('image/png');
  const key = state.curMoment;
  const m = state.moments[key];
  m.snapshots.push({dataURL, when: new Date().toISOString(), frame:m.frame, t:m.t});
  m.captured = true; save(); renderTabs(); // pestaña en verde
  // avanzar al siguiente momento
  const idx = MOMENTS.findIndex(mm=>mm.key===key);
  const next = MOMENTS[idx+1]?.key || key;
  setMoment(next);
};

notesEl.oninput = ()=>{ state.moments[state.curMoment].notes = notesEl.value; save(); };
fpsInput.onchange = ()=>{ state.fps = Number(fpsInput.value)||240; save(); updateTimeUI(); };

$('#printReport').onclick = ()=>{
  const container = document.getElementById('reportContent');
  container.innerHTML='';
  MOMENTS.forEach(m=>{
    const mm = state.moments[m.key];
    const latest = mm.snapshots[mm.snapshots.length-1];
    const checks = QUESTIONS[m.key].map((q,i)=>`<li>${mm.checks[i]?'✅':'⬜️'} ${q}</li>`).join('');
    const ms = mm.checks.filter(Boolean).length;
    const page = document.createElement('div');
    page.className='page';
    page.innerHTML = `
      <h2>${m.label}</h2>
      <div><small>t=${(mm.t||0).toFixed(3)}s • frame ${mm.frame||0}</small></div>
      ${latest? `<div><img src="${latest.dataURL}" alt="${m.label}" /></div>` : `<div style="color:#666;padding:12px;border:1px dashed #ccc;border-radius:8px">Sin captura</div>`}
      <div style="margin-top:6px"><strong>Puntaje del momento:</strong> ${ms}</div>
      <div><strong>Checklist</strong><ul>${checks}</ul></div>
      ${mm.notes ? `<div><strong>Notas:</strong> ${mm.notes}</div>` : ``}
    `;
    container.appendChild(page);
  });
  const total = Object.values(state.moments).reduce((acc,mm)=> acc + mm.checks.filter(Boolean).length, 0);
  const sum = document.createElement('div');
  sum.className='page';
  sum.innerHTML = `<h2>Resumen</h2>
    <div><strong>Puntaje total:</strong> ${total}</div>
    <div><strong>Clasificación:</strong> ${GRADE(total)}</div>`;
  container.prepend(sum);
  window.print();
};

$('#clearState').onclick = ()=>{ if (confirm('¿Borrar trabajo guardado?')) { localStorage.removeItem('smas_state_v3'); location.reload(); } };

/* ========= Carga de video ========= */
file.onchange = ()=>{
  const f=file.files[0]; if (!f) return;
  const url=URL.createObjectURL(f);
  vid.src=url; vid.load();
  vid.onloadedmetadata=()=>{ sizeCanvasToWrap(); vid.currentTime = 0.001; tmax.textContent = fmt(vid.duration||0); };
};

function init(){
  renderTabs(); setMoment(state.curMoment);
  fpsInput.value = state.fps;
}
init();
</script>
</body>
</html>